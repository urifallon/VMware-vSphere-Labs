VMW - Thực tế nhưng cần Router hoặc thiết bị chuyen dung de 
cac mang thay nhau

#Solution: Dùng DNS Server làm thiết bị trung gian luôn (1)
#DNS: Dùng DNS cấu hình các domain (2)

==============================================================

--------------------------------------------------------------
ESXI-MGNT
Short name: esxi.lab.local
  IP: 10.10.10.21
  VLAN: 10 (Management)

	------------------------------------------------------
	vCenter Server:
	  Hostname: vcenter.lab.local
	  Short name: vcenter.lab.local
	  IP: 10.10.10.10
	  VLAN: 10 (Management)

	Network:
	  Gateway: 10.10.10.51
	  Subnet: 10.10.10.0/24
	------------------------------------------------------

Network:
  Gateway: 10.10.10.1
  Subnet: 10.10.10.0/24
  VMnet8 (NAT)
--------------------------------------------------------------

--------------------------------------------------------------
DNS Server:
  Hostname: dns-01.lab.local
  Short name: dns1.lab.local
  IP: 10.10.10.51

Network:
  Gateway: 10.10.10.1
  Subnet: 10.10.10.0/24
  VMnet8 (NAT)

--------------------------------------------------------------

--------------------------------------------------------------
ESXi Host 1:
  Hostname: hcm-esxi-test.lab.local
  Short name: hcm1.lab.local
  IP: 10.20.10.21

Network:
  Gateway: 10.10.10.51
  Subnet: 10.20.10.0/24
  VMnet2 (Custom)

--------------------------------------------------------------

--------------------------------------------------------------
ESXi Host 2:
  Hostname: hn-esxi-test.lab.local
  Short name: hn1.lab.local
  IP: 10.30.10.21

Network:
  Gateway: 10.10.10.51
  Subnet: 10.30.10.0/24
  VMnet3 (Custom)

--------------------------------------------------------------

--------------------------------------------------------------
ESXi Host 3:
  Hostname: dn-esxi-test.lab.local
  Short name: dn1.lab.local
  IP: 10.40.10.21

Network:
  Gateway: 10.10.10.51
  Subnet: 10.30.10.0/24
  VMnet4 (Custom)

--------------------------------------------------------------

===============================================================

(1) Hướng dẫn dung DNS để cấu hình Domain

| STT   | Đường dẫn                               | Mục đích                                                     |
| ----- | --------------------------------------- | ------------------------------------------------------------ |
| **1** | `/etc/netplan/00-installer-config.yaml` | Cấu hình IP các NIC, gateway, DNS                            |
| **2** | `/etc/bind/named.conf.options`          | Cấu hình global DNS (forwarders, recursion, listen-on, v.v.) |
| **3** | `/etc/bind/named.conf.local`            | Khai báo zone forward + reverse                              |
| **4** | `/etc/bind/zones/db.lab.local`          | Zone thuận (A records, CNAME, NS, SOA)                       |
| **5** | `/etc/bind/zones/db.10.10.10`           | Zone ngược (PTR records)                                     |
| **6** | `/etc/rc.local` *(nếu có)*              | Cấu hình auto NAT + ip_forward khi reboot                    |


```
sudo apt update
sudo apt install bind9 bind9utils bind9-doc -y
```

```
sudo mkdir -p /etc/bind/zones
sudo chmod 755 /etc/bind/zones
```

`/etc/bind/named.conf.local`
```
//
// DNS Zones Configuration for lab.local
// Primary DNS Server: dns-01 (10.10.10.51)
//

zone "lab.local" {
    type master;
    file "/etc/bind/zones/db.lab.local";
    allow-update { none; };
    allow-transfer { none; };
    notify no;
};

zone "10.10.10.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.10.10.10";
    allow-update { none; };
    allow-transfer { none; };
    notify no;
};

```


`/etc/bind/zones/db.lab.local`
```
;
; DNS Zone file for lab.local
; File: /etc/bind/zones/db.lab.local
; Type: Master zone
; Updated: 2025-10-17
;
$TTL    86400
@       IN      SOA     dns-01.lab.local. admin.lab.local. (
                     2025101703         ; Serial (YYYYMMDDNN)
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL

@       IN      NS      dns-01.lab.local.

; Network Gateway
gateway         IN      A       10.10.10.1

; DNS Server
dns-01          IN      A       10.10.10.51
dns1            IN      CNAME   dns-01.lab.local.

; vCenter
vcenter         IN      A       10.10.10.10

; ESXi Host
esxi            IN      A       10.10.10.21

```

`/etc/bind/zones/db.10.10.10`
```
;
; BIND reverse data file for 10.10.10.0/24
; File: /etc/bind/zones/db.10.10.10
; Type: Master zone
; Updated: 2025-10-17
;
$TTL    86400
@       IN      SOA     dns-01.lab.local. admin.lab.local. (
                     2025101703
                         604800
                          86400
                        2419200
                          86400 )

@       IN      NS      dns-01.lab.local.

; PTR records
1       IN      PTR     gateway.lab.local.
10      IN      PTR     vcenter.lab.local.
21      IN      PTR     esxi.lab.local.
51      IN      PTR     dns-01.lab.local.

```

Command check:
```
sudo named-checkconf
sudo named-checkzone lab.local /etc/bind/zones/db.lab.local
sudo named-checkzone 10.10.10.in-addr.arpa /etc/bind/zones/db.10.10.10
```
Result check:
```
zone lab.local/IN: loaded serial 202510170x
OK
zone 10.10.10.in-addr.arpa/IN: loaded serial 202510170x
OK
```
Command controll service:
```
sudo systemctl restart bind9
sudo systemctl enable bind9
sudo systemctl status bind9
```
Command check DNS:
```
#Forward lookup
dig @127.0.0.1 vcenter.lab.local
dig @127.0.0.1 esxi.lab.local
dig @127.0.0.1 dns-01.lab.local

#Reverse lookup
dig @127.0.0.1 -x 10.10.10.21

#Ping test
ping esxi.lab.local
ping vcenter.lab.local

```


(2) Hướng dẫn cấu hình DNS router

STEP1:
Last login: Thu Oct 16 17:21:13 2025 from 10.10.10.1
installer@installer-VMware-Virtual-Platform:~$ sudo cat /etc/netplan/00-installer-config.yaml
[sudo] password for installer:
network:
  version: 2
  renderer: networkd
  ethernets:
    ens33:
      dhcp4: no
      addresses:
        - 10.10.10.51/24
      routes:
        - to: default
          via: 10.10.10.1
      nameservers:
        addresses: [127.0.0.1]
        search: [lab.local]

    ens37:
      dhcp4: no
      addresses:
        - 10.20.10.51/24

    ens38:
      dhcp4: no
      addresses:
        - 10.30.10.51/24

STEP2:
```
sudo netplan apply

nano /etc/sysctl.conf # bỏ command ở net.ipv4.tcp_syncookies = 1

sudo sysctl -p

sudo iptables -t nat -A POSTROUTING -s 10.0.0.0/8 -o ens33 -j MASQUERADE
```

Command check
```
cat /proc/sys/net/ipv4/ip_forward #check forwarding -> net.ipv4.tcp_syncookies = 1

sudo iptables -t nat -L -n -v #check rule iptables phải có dạng -> MASQUERADE  all  --  10.0.0.0/8  0.0.0.0/0  ...

```

Tự động thêm thủ công nếu muốn
```
sudo nano /etc/rc.local
```

```
#Thêm đoạn trước exit 0

sysctl -w net.ipv4.ip_forward=1
iptables -t nat -A POSTROUTING -s 10.0.0.0/8 -o ens33 -j MASQUERADE
```

```
sudo chmod +x /etc/rc.local
```

> (Khuyên dùng): Cài gói iptables-persistent nhưng đây lab mô phỏng bỏ qua cho dễ sử dụng

STEP3:
Tại VMW network cấu hình v2v3v4 về kiểu custom network (untick "connect a host virtual adapter to this network")

Step4:
Cấu hình toàn bộ Gateway các máy chủ theo dạng cấu hình ở server DNS

ESXi-MGNT
| NIC  | VMnet  | IP          | GW          |
| ---- | ------ | ----------- | ----------- |
| NIC1 | VMnet8 | 10.10.10.21 | 10.10.10.51 |

ESXi1
| NIC  | VMnet  | IP          | GW          |
| ---- | ------ | ----------- | ----------- |
| NIC1 | VMnet2 | 10.20.10.21 | 10.20.10.51 |

ESXi2
| NIC  | VMnet  | IP          | GW          |
| ---- | ------ | ----------- | ----------- |
| NIC1 | VMnet3 | 10.30.10.21 | 10.30.10.51 |

ESXi3
| NIC  | VMnet  | IP          | GW          |
| ---- | ------ | ----------- | ----------- |
| NIC1 | VMnet4 | 10.40.10.21 | 10.40.10.51 |

vCenter <-----------------------------------<
| NIC  | VMnet  | IP          | GW          |
| ---- | ------ | ----------- | ----------- |
| NIC1 | VMnet8 | 10.10.10.10 | 10.10.10.1  |


